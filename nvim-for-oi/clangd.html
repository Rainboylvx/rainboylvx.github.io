<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png }><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="nvim-lsp-clangd"><script>(function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.setAttribute("data-theme",e)})()</script><title>nvim-lsp-clangd | Rainboy's Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.4de9e3236bcb55312d0b2ff0fc62c694f607b9c0d95d0621f6c6dbacb7d6dbb5.css media=all><link rel=stylesheet href=/grid.css><link href="https://fonts.font.im/css?family=Roboto+Mono" rel=stylesheet><style>body,.heti,.heti--sans{font-family:roboto mono,monospace,times new roman,times,heti song,serif,apple color emoji,segoe ui emoji,segoe ui symbol}</style></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/><u>H</u>ome</a></li><li><a tabindex=-1 class=menu-link href=/tags><u>T</u>ags</a></li><li><span style=cursor:pointer id=theme-switcher class=menu-link type=button><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-4 w-4"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></span></li></ul></nav><div id=single-header><h1>nvim-lsp-clangd</h1><div id=single-meta><span class=datesub>2025-09-09 00:00</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://hugo-dead-simple.netlify.com/tags/nvim.html>#nvim</a>
</span>&nbsp; <span><a href=https://hugo-dead-simple.netlify.com/tags/oi.html>#oi</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><ul><li><a href=#核心思路>核心思路</a></li><li><a href=#步骤-1-安装-clangd>步骤 1: 安装 clangd</a></li><li><a href=#步骤-2-创建-compile_commandsjson-非常重要>步骤 2: 创建 <code>compile_commands.json</code> (非常重要!)</a></li><li><a href=#步骤-3-neovim-lua-配置>步骤 3: Neovim Lua 配置</a></li><li><a href=#步骤-4-在-initlua-中加载配置>步骤 4: 在 <code>init.lua</code> 中加载配置</a></li><li><a href=#配置解释>配置解释</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></aside><main class="heti heti--classic"><p>在 Neovim 中不使用 <code>nvim-lspconfig</code> 插件来手动配置 <code>clangd</code> 是一个很好的学习 Neovim 内置 LSP API 的方式。这能让你更深入地理解 LSP 客户端是如何工作的。</p><p>下面是详细的步骤和一份完整的 Lua 配置示例。</p><h3 id=核心思路>核心思路</h3><p>不使用 <code>nvim-lspconfig</code> 的核心是直接调用 Neovim 的原生 LSP 函数 <code>vim.lsp.start()</code>。这个函数负责启动一个 LSP 服务进程，并将其附加到当前的缓冲区。</p><p>主要步骤如下：</p><ol><li><strong>确保 <code>clangd</code> 已安装</strong>：Neovim 不会帮你安装 LSP 服务器，你需要自己通过系统包管理器安装。</li><li><strong>定义 <code>on_attach</code> 函数</strong>：这个函数在 LSP 成功附加到一个缓冲区后执行。我们在这里设置快捷键、高亮等。</li><li><strong>定义 LSP 服务器配置</strong>：创建一个配置表，告诉 Neovim 如何启动 <code>clangd</code>（命令、根目录、文件类型等）。</li><li><strong>使用 <code>autocmd</code> 触发 LSP</strong>：创建一个自动命令，在打开 C/C++ 文件时，调用 <code>vim.lsp.start()</code> 来启动 <code>clangd</code>。</li></ol><hr><h3 id=步骤-1-安装-clangd>步骤 1: 安装 clangd</h3><p>首先，确保你的系统上已经安装了 <code>clangd</code>。</p><ul><li><p><strong>macOS (Homebrew):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>brew install llvm
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># Homebrew 安装的 llvm 可能需要手动链接，或者你可以在配置中指定完整路径</span>
</span></span></code></pre></div></li><li><p><strong>Ubuntu/Debian:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>sudo apt update
</span></span><span class=line><span class=ln>2</span><span class=cl>sudo apt install clangd
</span></span></code></pre></div></li><li><p><strong>Arch Linux:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>sudo pacman -S clangd
</span></span></code></pre></div></li></ul><p>安装后，在终端运行 <code>clangd --version</code> 确认它已经安装并且在你的 <code>PATH</code> 中。</p><hr><h3 id=步骤-2-创建-compile_commandsjson-非常重要>步骤 2: 创建 <code>compile_commands.json</code> (非常重要!)</h3><p><code>clangd</code> 需要 <code>compile_commands.json</code> 文件来了解你的项目是如何编译的（比如头文件路径、宏定义等）。没有这个文件，<code>clangd</code> 的功能会大打折扣，尤其是在大型项目中。</p><p>如果你的项目使用 CMake，生成它非常简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 在你的构建目录中</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>cmake -DCMAKE_EXPORT_COMPILE_COMMANDS<span class=o>=</span><span class=m>1</span> ..
</span></span></code></pre></div><p>这会在构建目录中生成一个 <code>compile_commands.json</code> 文件。<code>clangd</code> 会自动在当前文件所在目录及父目录中寻找它。</p><hr><h3 id=步骤-3-neovim-lua-配置>步骤 3: Neovim Lua 配置</h3><p>将以下代码放入你的 Neovim 配置文件中（例如 <code>~/.config/nvim/lua/lsp/clangd.lua</code>），然后在你的 <code>init.lua</code> 中 <code>require</code> 它。</p><p>这是一个完整且带有详细注释的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=ln>  1</span><span class=cl><span class=c1>-- ~/.config/nvim/lua/lsp/clangd.lua</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl>
</span></span><span class=line><span class=ln>  3</span><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;加载自定义 clangd 配置...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=c1>-- 1. 定义 on_attach 函数</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=c1>--    这个函数会在 LSP 客户端成功附加到缓冲区时调用</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=c1>--    我们在这里为该缓冲区设置 LSP 相关的快捷键</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl><span class=kd>local</span> <span class=n>on_attach</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>bufnr</span><span class=p>)</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>  <span class=c1>-- 启用代码补全 (如果你使用 nvim-cmp)</span>
</span></span><span class=line><span class=ln> 10</span><span class=cl>  <span class=c1>-- client.server_capabilities.completionProvider = true -- 这行通常不需要，因为 capabilities 已经处理了</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>
</span></span><span class=line><span class=ln> 12</span><span class=cl>  <span class=n>print</span><span class=p>(</span><span class=s2>&#34;clangd 已附加到缓冲区: &#34;</span> <span class=o>..</span> <span class=n>bufnr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>
</span></span><span class=line><span class=ln> 14</span><span class=cl>  <span class=c1>-- 设置快捷键</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>  <span class=kd>local</span> <span class=n>opts</span> <span class=o>=</span> <span class=p>{</span> <span class=n>noremap</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span> <span class=n>silent</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>bufnr</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>  <span class=kd>local</span> <span class=n>keymap</span> <span class=o>=</span> <span class=n>vim.keymap</span><span class=p>.</span><span class=n>set</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>
</span></span><span class=line><span class=ln> 18</span><span class=cl>  <span class=c1>-- 跳转到定义</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;gd&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.definition</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>  <span class=c1>-- 查看悬浮文档</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;K&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.hover</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>  <span class=c1>-- 跳转到实现</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;gi&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.implementation</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>  <span class=c1>-- 列出引用</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;gr&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.references</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>  <span class=c1>-- 重命名符号</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;F2&gt;&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.rename</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>  <span class=c1>-- 显示代码动作 (修复、重构等)</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;leader&gt;ca&#39;</span><span class=p>,</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.code_action</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>  <span class=c1>-- 显示当前行的诊断信息 (错误、警告)</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;leader&gt;e&#39;</span><span class=p>,</span> <span class=n>vim.diagnostic</span><span class=p>.</span><span class=n>open_float</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>  <span class=c1>-- 跳转到上一个/下一个诊断</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;[d&#39;</span><span class=p>,</span> <span class=n>vim.diagnostic</span><span class=p>.</span><span class=n>goto_prev</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>  <span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span> <span class=s1>&#39;]d&#39;</span><span class=p>,</span> <span class=n>vim.diagnostic</span><span class=p>.</span><span class=n>goto_next</span><span class=p>,</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>  
</span></span><span class=line><span class=ln> 36</span><span class=cl>  <span class=c1>-- 设置高亮</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>  <span class=c1>-- 当光标移动到有引用的符号上时，高亮所有引用</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>  <span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_create_autocmd</span><span class=p>(</span><span class=s1>&#39;CursorHold&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>    <span class=n>buffer</span> <span class=o>=</span> <span class=n>bufnr</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>    <span class=n>callback</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>      <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.document_highlight</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>    <span class=kr>end</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>  <span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_create_autocmd</span><span class=p>(</span><span class=s1>&#39;CursorMoved&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>    <span class=n>buffer</span> <span class=o>=</span> <span class=n>bufnr</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>    <span class=n>callback</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>      <span class=n>vim.lsp</span><span class=p>.</span><span class=n>buf.clear_references</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=kr>end</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>
</span></span><span class=line><span class=ln> 51</span><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>
</span></span><span class=line><span class=ln> 53</span><span class=cl><span class=c1>-- 2. 定义 LSP 能力 (Capabilities)</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl><span class=c1>--    这告诉 LSP 服务器，客户端（Neovim）支持哪些功能</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl><span class=c1>--    如果你使用 nvim-cmp 进行补全，需要从 cmp_nvim_lsp 获取 capabilities</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl><span class=kd>local</span> <span class=n>capabilities</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s1>&#39;cmp_nvim_lsp&#39;</span><span class=p>).</span><span class=n>default_capabilities</span><span class=p>(</span><span class=n>vim.lsp</span><span class=p>.</span><span class=n>protocol.make_client_capabilities</span><span class=p>())</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>
</span></span><span class=line><span class=ln> 58</span><span class=cl><span class=c1>-- 3. 创建自动命令来启动 clangd</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl><span class=c1>--    当打开 C/C++/Objective-C 文件时，会触发这个自动命令</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_create_autocmd</span><span class=p>(</span><span class=s1>&#39;FileType&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>  <span class=n>pattern</span> <span class=o>=</span> <span class=p>{</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span> <span class=s1>&#39;cpp&#39;</span><span class=p>,</span> <span class=s1>&#39;objc&#39;</span><span class=p>,</span> <span class=s1>&#39;objcpp&#39;</span><span class=p>,</span> <span class=s1>&#39;cuda&#39;</span> <span class=p>},</span> <span class=c1>-- 触发 clangd 的文件类型</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>  <span class=n>callback</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>    <span class=c1>-- 使用 vim.lsp.start() 启动客户端</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>    <span class=n>vim.lsp</span><span class=p>.</span><span class=n>start</span><span class=p>({</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>      <span class=c1>-- 客户端的名称，可以自定义</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>      <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;my-clangd-server&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>
</span></span><span class=line><span class=ln> 68</span><span class=cl>      <span class=c1>-- 启动 LSP 服务器的命令</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>      <span class=c1>-- 如果 clangd 不在你的 PATH 中，你需要提供完整路径</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>      <span class=c1>-- 你也可以在这里传递 clangd 的命令行参数</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>      <span class=n>cmd</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>        <span class=s1>&#39;clangd&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>        <span class=s1>&#39;--query-driver=/usr/bin/gcc,**/gcc-*,/usr/bin/g++,**/g++-*&#39;</span><span class=p>,</span> <span class=c1>-- 帮助 clangd 找到系统头文件</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>        <span class=s1>&#39;--background-index&#39;</span><span class=p>,</span>       <span class=c1>-- 后台索引</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>        <span class=s1>&#39;--clang-tidy&#39;</span><span class=p>,</span>             <span class=c1>-- 启用 clang-tidy</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>        <span class=s1>&#39;--completion-style=detailed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>
</span></span><span class=line><span class=ln> 79</span><span class=cl>      <span class=c1>-- 查找项目根目录的逻辑</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>      <span class=c1>-- clangd 会自动寻找 compile_commands.json 或 .git 目录</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>      <span class=c1>-- 这里使用 Neovim 内置的工具函数</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>      <span class=n>root_dir</span> <span class=o>=</span> <span class=n>vim.lsp</span><span class=p>.</span><span class=n>util.root_pattern</span><span class=p>(</span><span class=s1>&#39;.git&#39;</span><span class=p>,</span> <span class=s1>&#39;compile_commands.json&#39;</span><span class=p>,</span> <span class=s1>&#39;compile_flags.txt&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>
</span></span><span class=line><span class=ln> 84</span><span class=cl>      <span class=c1>-- 文件类型</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>      <span class=n>filetypes</span> <span class=o>=</span> <span class=p>{</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span> <span class=s1>&#39;cpp&#39;</span><span class=p>,</span> <span class=s1>&#39;objc&#39;</span><span class=p>,</span> <span class=s1>&#39;objcpp&#39;</span><span class=p>,</span> <span class=s1>&#39;cuda&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>
</span></span><span class=line><span class=ln> 87</span><span class=cl>      <span class=c1>-- 附加函数</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>      <span class=n>on_attach</span> <span class=o>=</span> <span class=n>on_attach</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>
</span></span><span class=line><span class=ln> 90</span><span class=cl>      <span class=c1>-- 能力</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>      <span class=n>capabilities</span> <span class=o>=</span> <span class=n>capabilities</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>
</span></span><span class=line><span class=ln> 93</span><span class=cl>      <span class=c1>-- 服务器特定设置 (settings)</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>      <span class=c1>-- 对于 clangd，大多数配置通过命令行参数或 .clangd 配置文件完成</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>      <span class=n>settings</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>        <span class=c1>-- 这里可以放一些 clangd 的特定配置，但通常留空</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>  <span class=kr>end</span><span class=p>,</span>
</span></span><span class=line><span class=ln>100</span><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>
</span></span><span class=line><span class=ln>102</span><span class=cl><span class=c1>-- (可选) 配置诊断信息的显示方式</span>
</span></span><span class=line><span class=ln>103</span><span class=cl><span class=n>vim.diagnostic</span><span class=p>.</span><span class=n>config</span><span class=p>({</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>  <span class=n>virtual_text</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>-- 在行尾显示错误信息</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>  <span class=n>signs</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>        <span class=c1>-- 在行号列显示图标</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>  <span class=n>underline</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>  <span class=n>update_in_insert</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>  <span class=n>severity_sort</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=ln>109</span><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>
</span></span><span class=line><span class=ln>111</span><span class=cl><span class=c1>-- (可选) 设置诊断图标 (需要 Nerd Font 字体支持)</span>
</span></span><span class=line><span class=ln>112</span><span class=cl><span class=kd>local</span> <span class=n>signs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>Error</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>Warn</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>Hint</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>Info</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>113</span><span class=cl><span class=kr>for</span> <span class=n>type</span><span class=p>,</span> <span class=n>icon</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>signs</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>  <span class=kd>local</span> <span class=n>hl</span> <span class=o>=</span> <span class=s2>&#34;DiagnosticSign&#34;</span> <span class=o>..</span> <span class=n>type</span>
</span></span><span class=line><span class=ln>115</span><span class=cl>  <span class=n>vim.fn</span><span class=p>.</span><span class=n>sign_define</span><span class=p>(</span><span class=n>hl</span><span class=p>,</span> <span class=p>{</span> <span class=n>text</span> <span class=o>=</span> <span class=n>icon</span><span class=p>,</span> <span class=n>texthl</span> <span class=o>=</span> <span class=n>hl</span><span class=p>,</span> <span class=n>numhl</span> <span class=o>=</span> <span class=n>hl</span> <span class=p>})</span>
</span></span><span class=line><span class=ln>116</span><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=ln>117</span><span class=cl>
</span></span><span class=line><span class=ln>118</span><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;自定义 clangd 配置加载完毕。&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=步骤-4-在-initlua-中加载配置>步骤 4: 在 <code>init.lua</code> 中加载配置</h3><p>确保在你的主配置文件 <code>init.lua</code> 中加载上面创建的 Lua 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=ln>1</span><span class=cl><span class=c1>-- ~/.config/nvim/init.lua</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1>-- ... 其他配置 ...</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=c1>-- 加载 LSP 相关配置</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=n>require</span><span class=p>(</span><span class=s1>&#39;lsp.clangd&#39;</span><span class=p>)</span> <span class=c1>-- 假设你把文件放在 lua/lsp/clangd.lua</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=c1>-- ... 其他配置 ...</span>
</span></span></code></pre></div><h3 id=配置解释>配置解释</h3><ol><li><p><strong><code>on_attach</code> 函数</strong>: 这是自定义 LSP 行为的关键。它只会在 LSP 客户端成功连接到当前文件后执行，确保了 <code>vim.lsp.buf.*</code> 系列函数可用。将快捷键设置在这里可以避免在没有 LSP 的缓冲区中创建无效的快捷键。</p></li><li><p><strong><code>capabilities</code></strong>: 这个配置非常重要，特别是当你使用 <code>nvim-cmp</code> 这样的补全插件时。它告诉 <code>clangd</code>，Neovim 客户端支持哪些功能（例如，代码片段补全、动态注册等）。<code>cmp_nvim_lsp</code> 提供了一个方便的函数来生成这个配置。如果你不使用补全插件，可以使用默认的 <code>vim.lsp.protocol.make_client_capabilities()</code>。</p></li><li><p><strong><code>vim.lsp.start()</code></strong>: 这是核心函数。</p><ul><li><code>name</code>: 一个唯一的标识符，方便调试。</li><li><code>cmd</code>: 一个包含命令及其参数的 table。这是告诉 Neovim 如何启动 <code>clangd</code> 进程的地方。你可以添加 <code>clangd</code> 支持的各种命令行参数来微调其行为。</li><li><code>root_dir</code>: <code>vim.lsp.util.root_pattern</code> 是一个辅助函数，它会从当前文件所在的目录开始向上查找，直到找到 <code>.git</code> 目录或 <code>compile_commands.json</code> 文件，并将其所在的目录作为项目根目录。</li><li><code>on_attach</code>: 引用我们之前定义的函数。</li></ul></li><li><p><strong><code>autocmd</code></strong>: <code>FileType</code> 事件是最适合用来启动 LSP 的时机。当 Neovim 识别到一个文件的类型是 <code>c</code> 或 <code>cpp</code> 等时，就会执行回调函数，从而启动 <code>clangd</code>。</p></li></ol><h3 id=总结>总结</h3><p>通过这种手动方式，你可以完全控制 <code>clangd</code> 的启动参数和行为，而无需依赖任何中间层插件。虽然 <code>nvim-lspconfig</code> 通过预设的社区配置简化了这个过程，但了解其底层原理对于调试问题和进行深度定制非常有帮助。</p><p>现在，重启 Neovim 并打开一个 C/C++ 项目（确保有 <code>compile_commands.json</code>），你应该能看到 <code>clangd</code> 成功启动，并且你设置的快捷键也能正常工作了。</p></main><br><footer><div class=footer-info><p>Copyright &copy; 2025 Rainboy. All rights reserved.
<span>| Last build: 2025-10-24 15:51:58</span></p></div><script defer>document.addEventListener("keydown",function(e){if(document.activeElement.isContentEditable)return!1;if(document.activeElement.tagName=="INPUT")return!1;if(e.altKey||e.ctrlKey||e.shiftKey)return!1;var t=e.key;if(t==="h")e.preventDefault(),e.stopPropagation(),window.location.href="/";else if(t==="t")e.preventDefault(),e.stopPropagation(),window.location.href=`https://${location.hostname}/tags`;else if(t==="i"){e.preventDefault(),e.stopPropagation();const t=document.querySelectorAll("input");for(let e=0;e<t.length;e++)if(t[e].offsetParent!==null){t[e].selectionStart=t[e].selectionEnd=t[e].value.length,t[e].focus();break}}return!1})</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,200))}setTimeout(scrollHandler,100)</script><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]:not(.output):not([class*="language-console"])');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const s=e.querySelectorAll(".cl");let n="";s.forEach(e=>{n+=e.innerText}),navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer src=/js/theme-switcher.js></script></footer></body></html>