<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png }><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content><script>(function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.setAttribute("data-theme",e)})()</script><title>| Rainboy's Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.9e52618e081d7542403ff6356f894d993b93e26eb37d3f072c70cd92f0c439ab.css media=all><link rel=stylesheet href=/grid.css><link href="https://fonts.font.im/css?family=Roboto+Mono" rel=stylesheet><style>body,.heti,.heti--sans{font-family:roboto mono,monospace,times new roman,times,heti song,serif,apple color emoji,segoe ui emoji,segoe ui symbol}</style></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/><u>H</u>ome</a></li><li><a tabindex=-1 class=menu-link href=/tags><u>T</u>ags</a></li><li><span style=cursor:pointer id=theme-switcher class=menu-link type=button><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-4 w-4"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></span></li></ul></nav><div id=single-header><h1></h1><div id=single-meta></div></div><main class="heti heti--classic"><h2 id=第-8-章-域名及网络地址>第 8 章 域名及网络地址</h2><p>本章代码，在<a href=https://github.com/riba2534/TCP-IP-NetworkNote target=_blank rel="noreferrer nofollow">TCP-IP-NetworkNote</a>中可以找到。</p><h3 id=81-域名系统>8.1 域名系统</h3><p>DNS 是对IP地址和域名进行相互转换的系统，其核心是 DNS 服务器</p><h4 id=811-什么是域名>8.1.1 什么是域名</h4><p>域名就是我们常常在地址栏里面输入的地址，将比较难记忆的IP地址变成人类容易理解的信息。</p><h4 id=812-dns-服务器>8.1.2 DNS 服务器</h4><p>相当于一个字典，可以查询出某一个域名对应的IP地址</p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c41854859ae3.png alt></p></p><p>如图所示，显示了 DNS 服务器的查询路径。</p><h3 id=82-ip地址和域名之间的转换>8.2 IP地址和域名之间的转换</h3><h4 id=821-程序中有必要使用域名吗>8.2.1 程序中有必要使用域名吗？</h4><p>一句话，需要，因为IP地址可能经常改变，而且也不容易记忆，通过域名可以随时更改解析，达到更换IP的目的</p><h4 id=822-利用域名获取ip地址>8.2.2 利用域名获取IP地址</h4><p>使用以下函数可以通过传递字符串格式的域名获取IP地址</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netdb.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=cp></span><span class=k>struct</span> <span class=n>hostent</span> <span class=o>*</span><span class=nf>gethostbyname</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>hostname</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=cm>成功时返回 hostent 结构体地址，失败时返回 NULL 指针
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=cm>*/</span>
</span></span></code></pre></div><p>这个函数使用方便，只要传递字符串，就可以返回域名对应的IP地址。只是返回时，地址信息装入 hostent 结构体。此结构体的定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>struct</span> <span class=n>hostent</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>h_name</span><span class=p>;</span>       <span class=cm>/* Official name of host.  */</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=kt>char</span> <span class=o>**</span><span class=n>h_aliases</span><span class=p>;</span>   <span class=cm>/* Alias list.  */</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=kt>int</span> <span class=n>h_addrtype</span><span class=p>;</span>     <span class=cm>/* Host address type.  */</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=kt>int</span> <span class=n>h_length</span><span class=p>;</span>       <span class=cm>/* Length of address.  */</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>    <span class=kt>char</span> <span class=o>**</span><span class=n>h_addr_list</span><span class=p>;</span> <span class=cm>/* List of addresses from name server.  */</span>
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>从上述结构体可以看出，不止返回IP信息，同事还带着其他信息一起返回。域名转换成IP时只需要关注 h_addr_list 。下面简要说明上述结构体的成员：</p><ul><li>h_name：该变量中存有官方域名（Official domain name）。官方域名代表某一主页，但实际上，一些著名公司的域名并没有用官方域名注册。</li><li>h_aliases：可以通过多个域名访问同一主页。同一IP可以绑定多个域名，因此，除官方域名外还可以指定其他域名。这些信息可以通过 h_aliases 获得。</li><li>h_addrtype：gethostbyname 函数不仅支持 IPV4 还支持 IPV6 。因此可以通过此变量获取保存在 h_addr_list 的IP地址族信息。若是 IPV4 ，则此变量中存有 AF_INET。</li><li>h_length：保存IP地址长度。若是 IPV4 地址，因为是 4 个字节，则保存4；IPV6 时，因为是 16 个字节，故保存 16</li><li>h_addr_list：这个是最重要的的成员。通过此变量以整数形式保存域名相对应的IP地址。另外，用户比较多的网站有可能分配多个IP地址给同一个域名，利用多个服务器做负载均衡，。此时可以通过此变量获取IP地址信息。</li></ul><p>调用 gethostbyname 函数后，返回的结构体变量如图所示：</p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c41898ae45e8.png alt></p></p><p>下面的代码通过一个例子来演示 gethostbyname 的应用，并说明 hostent 结构体变量特性。</p><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch08/gethostbyname.c target=_blank rel="noreferrer nofollow">gethostbyname.c</a></li></ul><p>编译运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=ln>1</span><span class=cl>gcc gethostbyname.c -o hostname
</span></span><span class=line><span class=ln>2</span><span class=cl>./hostname www.baidu.com
</span></span></code></pre></div><p>结果：</p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c418faf20495.png alt></p></p><p>如图所示，显示出了对百度的域名解析</p><p>可以看出，百度有一个域名解析是 CNAME 解析的，指向了<code>shifen.com</code>，关于百度具体的解析过程。</p><blockquote><p>这一部分牵扯到了很多关于DNS解析的过程，还有 Linux 下关于域名解析的一些命令，我找了一部分资料，可以点下面的链接查看比较详细的：</p><ul><li><a href="http://zhan.renren.com/starshen?gid=3602888498023142484&amp;checked=true" target=_blank rel="noreferrer nofollow">关于百度DNS的解析过程</a></li><li><a href=https://www.zhihu.com/question/23042131/answer/66571369 target=_blank rel="noreferrer nofollow">DNS解析的过程是什么，求详细的？</a></li><li><a href=https://zhuanlan.zhihu.com/p/45535596 target=_blank rel="noreferrer nofollow">Linux DNS 查询剖析</a></li><li><a href=http://www.live-in.org/archives/1938.html target=_blank rel="noreferrer nofollow">Linux DNS查询命令</a></li><li><a href=https://blog.csdn.net/shangdi1988/article/details/65713077 target=_blank rel="noreferrer nofollow">Linux中DNS服务器地址查询命令nslookup使用教程</a></li><li><a href=http://www.ruanyifeng.com/blog/2016/06/dns.html target=_blank rel="noreferrer nofollow">DNS 原理入门</a></li></ul></blockquote><p>仔细阅读这一段代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=nf>inet_ntoa</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=k>struct</span> <span class=n>in_addr</span> <span class=o>*</span><span class=p>)</span><span class=n>host</span><span class=o>-&gt;</span><span class=n>h_addr_list</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span></code></pre></div><p>若只看 hostent 的定义，结构体成员 h_addr_list 指向字符串指针数组（由多个字符串地址构成的数组）。但是字符串指针数组保存的元素实际指向的是 in_addr 结构体变量中地址值而非字符串，也就是说<code>(struct in_addr *)host->h_addr_list[i]</code>其实是一个指针，然后用<code>*</code>符号取具体的值。如图所示：</p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c419658a73b8.png alt></p></p><h4 id=823-利用ip地址获取域名>8.2.3 利用IP地址获取域名</h4><p>请看下面的函数定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netdb.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=cp></span><span class=k>struct</span> <span class=n>hostent</span> <span class=o>*</span><span class=nf>gethostbyaddr</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>addr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>family</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=cm>成功时返回 hostent 结构体变量地址值，失败时返回 NULL 指针
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=cm>addr: 含有IP地址信息的 in_addr 结构体指针。为了同时传递 IPV4 地址之外的全部信息，该变量的类型声明为 char 指针
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=cm>len: 向第一个参数传递的地址信息的字节数，IPV4时为 4 ，IPV6 时为16.
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=cm>family: 传递地址族信息，ipv4 是 AF_INET ，IPV6是 AF_INET6
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=cm>*/</span>
</span></span></code></pre></div><p>下面的代码演示使用方法：</p><ul><li><a href=https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch08/gethostbyaddr.c target=_blank rel="noreferrer nofollow">gethostbyaddr.c</a></li></ul><p>编译运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=ln>1</span><span class=cl>gcc gethostbyaddr.c -o hostaddr
</span></span><span class=line><span class=ln>2</span><span class=cl>./hostaddr 8.8.8.8
</span></span></code></pre></div><p>结果：</p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c41a019085d4.png alt></p></p><p>从图上可以看出，<code>8.8.8.8</code>这个IP地址是谷歌的。</p><h3 id=83-基于-windows-的实现>8.3 基于 Windows 的实现</h3><p>暂略</p><h3 id=84-习题>8.4 习题</h3><blockquote><p>以下答案仅代表本人个人观点，可能不是正确答案。</p></blockquote><ol><li><p><strong>下列关于DNS的说法错误的是？</strong></p><p>答：字体加粗的表示正确答案。</p><ol><li><strong>因为DNS从存在，故可以使用域名代替IP</strong></li><li>DNS服务器实际上是路由器，因为路由器根据域名决定数据的路径</li><li><strong>所有域名信息并非集中与 1 台 DNS 服务器，但可以获取某一 DNS 服务器中未注册的所有地址</strong></li><li>DNS 服务器根据操作系统进行区分，Windows 下的 DNS 服务器和 Linux 下的 DNS 服务器是不同的。</li></ol></li><li><p><strong>阅读如下对话，并说明东秀的方案是否可行。（因为对话的字太多，用图代替）</strong></p><p><p class=imgp><img loading=lazy src=https://i.loli.net/2019/01/18/5c41a22f35390.png alt></p></p><p>答：答案就是可行，DNS 服务器是分布式的，一台坏了可以找其他的。</p></li><li><p><strong>在浏览器地址输入 <a href=https://www.orentec.co.kr target=_blank rel="noreferrer nofollow">www.orentec.co.kr</a> ，并整理出主页显示过程。假设浏览器访问默认 DNS 服务器中并没有关于 <a href=https://www.orentec.co.kr target=_blank rel="noreferrer nofollow">www.orentec.co.kr</a> 的地址信息.</strong></p><p>答：可以参考一下知乎回答，<a href=https://www.zhihu.com/question/34873227/answer/518086565 target=_blank rel="noreferrer nofollow">在浏览器地址栏输入一个URL后回车，背后会进行哪些技术步骤？</a>,我用我自己的理解，简单说一下，首先会去向上一级的 DNS 服务器去查询，通过这种方式逐级向上传递信息，一直到达根服务器时，它知道应该向哪个 DNS 服务器发起询问。向下传递解析请求，得到IP地址候原路返回，最后会将解析的IP地址传递到发起请求的主机。</p></li></ol><h2 id=代码>代码</h2><p>gethostbyaddr.c</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=p>{{</span><span class=err>#</span><span class=n>include</span> <span class=n>chapter_8</span><span class=o>/</span><span class=n>gethostbyaddr</span><span class=p>.</span><span class=n>c</span><span class=p>}}</span>
</span></span></code></pre></div><p>gethostbyname.c</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=p>{{</span><span class=err>#</span><span class=n>include</span> <span class=n>chapter_8</span><span class=o>/</span><span class=n>gethostbyname</span><span class=p>.</span><span class=n>c</span><span class=p>}}</span>
</span></span></code></pre></div></main><br><footer><div class=footer-info><p>Copyright &copy; 2025 Rainboy. All rights reserved.
<span>| Last build: 2025-09-07 14:59:41</span></p></div><script defer>document.addEventListener("keydown",function(e){if(document.activeElement.isContentEditable)return!1;if(document.activeElement.tagName=="INPUT")return!1;if(e.altKey||e.ctrlKey||e.shiftKey)return!1;var t=e.key;if(t==="h")e.preventDefault(),e.stopPropagation(),window.location.href="/";else if(t==="t")e.preventDefault(),e.stopPropagation(),window.location.href=`https://${location.hostname}/tags`;else if(t==="i"){e.preventDefault(),e.stopPropagation();const t=document.querySelectorAll("input");for(let e=0;e<t.length;e++)if(t[e].offsetParent!==null){t[e].selectionStart=t[e].selectionEnd=t[e].value.length,t[e].focus();break}}return!1})</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,200))}setTimeout(scrollHandler,100)</script><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]:not(.output):not([class*="language-console"])');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const s=e.querySelectorAll(".cl");let n="";s.forEach(e=>{n+=e.innerText}),navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer src=/js/theme-switcher.js></script></footer></body></html>